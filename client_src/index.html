<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<script type="text/javascript" src="js/d3.js"></script>
	<script type="text/javascript" src="js/jquery.js"></script>
	<script type="text/javascript" src="js/underscore.js"></script>
	<script type="text/javascript" src="js/backbone.js"></script>
	<script type="text/javascript" src="js/ElphabaModel.js"></script>
	<script type="text/javascript" src="js/TypingState.js"></script>
	<script type="text/javascript" src="js/TypingModel.js"></script>
	<script type="text/javascript" src="js/TypingUI.js"></script>

	<script type="text/javascript">
	$(document).ready( function() {
		typingState = new TypingState();
		typingModel = new TypingModel({ "state" : typingState });
		typingUI = new TypingUI({ "model" : typingModel });
		
		typingState.on( "token", updateTargetText );
		d3.select( "#tgt-input" ).on( "keyup", function() { typingState.setUserText( d3.event.srcElement.value ) } );
		initEventHandlers();
	});
	
	// URL of the PTM service
	var _serverURL = 'http://joan.stanford.edu:8017/t';
//	var _serverURL = 'http://localhost:8888/cgi-bin/redirect.py';
	
	var updateTargetText = function() {
		// Get source text
		var source = $('#src-input').val();
		
		// Get user-entered target prefix
	    var tgtPrefix = typingState.getUserText();

		// Translation message
		var msg = {
			src : "AR",
			tgt : "EN",
			n : 3,
			text : source,
			tgtPrefix : tgtPrefix,
		};

		// Make ajax request
		var ajaxTime = Date.now();
		$.ajax({
			url: _serverURL,
			dataType: "json",
			data: {tReq : JSON.stringify(msg), },
			//      xhrFields: {
			//        withCredentials: true
			//      },
			success: function(data){
				//response is a callback
				var totalTime = (Date.now()-ajaxTime) / 1000;
				console.log(data);
				$('#output').empty();
				for (var i = 0; i < data.tgtList.length; i++) {
					$('#output').append('<p>' + data.tgtList[i] + '</p>');
				}
				$('#output').append('<span style="font-size:small;color:red">request: ' + totalTime.toFixed(2).toString() + 's</span>');

				// Load top MT into the Typing UI
				var mtText = data.tgtList[0];
				var userText = typingState.getUserText();
				var futureText = mtText.substr( userText.length );
				typingState.setFutureText( futureText );
			},
			error: function(jqXHR, textStatus, errorThrown){
				console.log("Translation failed");
				console.log(errorThrown);
			},
		});
	};
	
	var initEventHandlers = function() {
		  $('#src-input').change(function(e) {
		    var source = $('#src-input').val();
		    var msg = {
		      src : "AR",
		      tgt : "EN",
		      n : 3,
		      text : source,
		      tgtPrefix : "",
		    };
		    var ajaxTime = Date.now();
		    $.ajax({
		      url: _serverURL,
		      dataType: "json",
		      data: {tReq : JSON.stringify(msg), },
		//      xhrFields: {
		//        withCredentials: true
		//      },
		      success: function(data){
		        //response is a callback
		        var totalTime = (Date.now()-ajaxTime) / 1000;
		        console.log(data);
		        $('#output').empty();
		        for (var i = 0; i < data.tgtList.length; i++) {
		          $('#output').append('<p>' + data.tgtList[i] + '</p>');
		        }
		        $('#output').append('<span style="font-size:small;color:red">request: ' + totalTime.toFixed(2).toString() + 's</span>');

				// Load top MT into the Typing UI
				var mtText = data.tgtList[0];
				var userText = typingState.getUserText();
				var futureText = mtText.substr( userText.length );
				typingState.setFutureText( futureText );
		      },
		      error: function(jqXHR, textStatus, errorThrown){
		        console.log("Translation failed");
		        console.log(errorThrown);
		      },
		    });
		  });
	}
	</script>

    <title>Phrasal Debug Interface</title>
</head>

<body>

<div id="source">
Source (enter text, then tab to target box):
<br>
<textarea cols="60" rows="10" id="src-input"></textarea>
</div>

<br>

Target (updates retrieved on space key):
<br>
<div id="textbox">
<form action="" name="form-tgt-input" id="form-tgt-input">
<textarea cols="60" rows="10" id="tgt-input" disabled style="background: #eee"></textarea>
</form>
</div>

<br>

<div class="TypingUI"></div><br/>

<div id="output"></div>

</body>
</html>
